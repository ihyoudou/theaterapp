{% extends '_base.html' %}

{% block title %}{{movie.title}} | {{APP_NAME}}{% endblock %}

{% block content %}

{% include '_navbar.html' %}


<div class="container">
    <div class="row">
        <div class="col-md">
            <img src="https://picsum.photos/400/600" class="img-fluid" alt="movie poster">
        </div>

        <div class="col-md">
            <h1>{{movie.title}}</h1>
            <div>
                <h4>Description</h4>
            
                <p>{{movie.description}}</p>

                <hr>
                {% if movie.getDirector %}
                    <h4>Director</h4>
                    <span class="lead">{{movie.getDirector}}</span>
                    <hr>
                {% endif %}

                <h4>Release date</h4>
                <span class="lead">{{movie.release_date}}</span>

                <hr>
                <h4>Rating</h4>
                
                    <div class="row">
                        <div class="col">
                            <h3 class="text-center">{{movie.avgRating}}</h3>
                        </div>
                        <div class="col">
                            <span class="text-center">(based on {{movie.countRating}} ratings)</span>

                            <div>
                                <span>
                                    {{ratingForm}}
                                    <button class="btn btn-primary btn-sm" id="buttonRate">Rate</button>
                                    <div id="spinner"></div>
                                </span>
                            </div>

                        </div>
                    </div>
                    
                <hr>
                <h4>Ticket price: <span class="lead">{{movie.price}}</span>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#buyTicketModal" >Buy ticket</button>
                </h4>
            </div>
            
            

        </div>
        
    </div>

</div>

<!-- Modal -->
<div class="modal fade" id="buyTicketModal" tabindex="-1" aria-labelledby="buyTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="buyTicketModalLabel">Buy ticket</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Do you want to buy ticket for movie "{{movie.title}}"?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="buyTicketBtnConfirm">Confirm</button>
        </div>
      </div>
    </div>
  </div>

<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        spinner = document.getElementById("spinner");
        function hideFunc() {
            const buyTicketModal = document.querySelector('#buyTicketModal');
            const modal = bootstrap.Modal.getInstance(buyTicketModal);    
            modal.hide();
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        document.getElementById('buyTicketBtnConfirm').addEventListener('click', buyTicket, true);
        function buyTicket(){
            spinner.innerHTML = '<div class="spinner-border" role="status">';

            fetch("{% url 'core:buyMovieTicket' %}", {
                method: "POST",
                headers: {'X-CSRFToken': csrftoken},
                body: JSON.stringify({
                    movieID: '{{movie.id}}'
                })
            })
            .then(res => res.json())
            .then(res => {
                spinner.innerHTML = '';
                if(res['success'] == true){
                    alert("Your purchase was successful!");
                    
                } else {
                    if(res['reason'] == "Movie not found"){
                        alert("Movie was not found")
                    } else {
                        alert("Unexpected error, please try again later");
                    }
                }
                console.log(res);
                hideFunc();
            })
        }

        document.getElementById('buttonRate').addEventListener('click', sendFeedback, true);

        function sendFeedback(){
            rating = document.getElementById("id_rating");
            movieID = '{{movie.id}}';
            spinner.innerHTML = '<div class="spinner-border" role="status">';

            fetch("{% url 'core:rateMovie' %}", {
                method: "POST",
                headers: {'X-CSRFToken': csrftoken},
                body: JSON.stringify({
                    rate: rating.value,
                    movieID: movieID
                })
            })
            .then(res => res.json())
            .then(res => {
                spinner.innerHTML = '';
                if(res['success'] == true){
                    alert("Your feedback was saved!");
                } else {
                    if(res['reason'] == "this user already rated that movie"){
                        alert("You already send feedback for that movie!")
                    } else if(res['reason'] == "user is not authenticated"){
                        alert("You need to be loged in to vote!")
                    } else {
                        alert("Unexpected error, please try again later");
                    }
                }
                console.log(res);
            })
            console.log(movieID);
        }
    })
</script>
{% endblock %}